name: Kubernetes
on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Get Kubernetes version
        id: collect
        run: |-
          # Get latest Kubernetes version
          KUBERNETES_VERSION=$(curl -s https://registry.hub.docker.com/v2/repositories/rancher/k3s/tags\?name\=k3s1  | jq -r '.results[]["name"] |  sub("(?<version>[0-9]+\\.[0-9]+\\.[0-9]+).*";.version)' | sort -V -r | head -n 1)
          CURRENT_VERSION=$(curl --silent --fail -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/orgs/jumppad-labs/packages/docker/kubernetes/versions | jq -r '.[]["name"]'| head -n 1)

          echo "version=$KUBERNETES_VERSION" >> "$GITHUB_OUTPUT"
          echo "current=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

          echo $KUBERNETES_VERSION
          echo $CURRENT_VERSION

      - name: Setup Docker Multi-Arch Builder
        if: steps.collect.outputs.version != steps.collect.outputs.current
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --name multi
          docker buildx use multi
          docker buildx inspect --bootstrap

      - name: Build and load into local Docker
        if: steps.collect.outputs.version != steps.collect.outputs.current
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t ghcr.io/jumppad-labs/kubernetes:${steps.collect.outputs.version} \
            -f kubernetes/Dockerfile \
            kubernetes \
            --load
